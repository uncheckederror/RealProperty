@page
@model ServerSide.Pages.RealPropertyTaxYearsModel
@{
    ViewBag.Title = string.IsNullOrWhiteSpace(Model?.ParcelNumber) ? "Accounts" : Model?.ParcelNumber;
}
<script type="text/javascript">
    function handleSearchQuery(textBox) {
        var route = '/RealPropertyAccounts/Search?Query=';

        fetch(`${route}${textBox.value}`)
            .then(
                function (response) {
                    if (response.status !== 200) {
                        console.log('Looks like there was a problem. Status Code: ' +
                            response.status);
                        return;
                    }

                    // Examine the text in the response
                    response.json().then(function (data) {
                        console.log(data);

                        var options = '';

                        for (var i = 0; i < data.length; i++) {
                            options += '<option value="' + data[i] + '" />';
                        }

                        var datalist = document.createElement("datalist");
                        datalist.id = 'realaccountoptions';
                        datalist.innerHTML = options;
                        var textBox = document.getElementById("searchInput");
                        var check = document.getElementById('realaccountoptions');
                        if (typeof (check) != 'undefined' && check != null) {
                            check.remove();
                        }
                        textBox.appendChild(datalist);
                        textBox.setAttribute('list', 'realaccountoptions');
                        console.log(datalist);
                    });
                }
            )
            .catch(function (err) {
                console.log('Fetch Error :-S', err);
            });
    }

    function onInput(textBox) {
        var val = document.getElementById("searchInput").value;
        var check = document.getElementById('realaccountoptions');
        if (typeof (check) != 'undefined' && check != null) {
            var opts = document.getElementById('realaccountoptions').childNodes;
            for (var i = 0; i < opts.length; i++) {
                if (opts[i].value === val) {
                    var form = document.getElementById("searchForm");
                    form.submit();
                }
            }
        }
        handleSearchQuery(textBox);
    }

</script>

@{
    if (Model?.TaxYears is not null && Model.TaxYears.Any())
    {
        <section class="hero is-success is-small">
            <div class="hero-body container">
                <div class="has-text-centered">
                    <p class="title is-1">Tax Years</p>
                    <p class="subtitle">A service of King County</p>
                    <form asp-page="./RealPropertyTaxYears" method="get" id="searchForm">
                        <div class="field is-grouped">
                            <p class="control is-expanded">
                                <input id="searchInput" class="input is-large" name="accountNumber" type="text" placeholder="Enter an account number" value="@Model?.ParcelNumber" onchange="handleSearchQuery(this)" autocomplete="off" oninput="onInput(this)">
                            </p>
                            @*<p class="control">
                                    <input type="submit" id="submitSearch" value="Search" class="button is-large is-success is-inverted is-focused" />
                                </p>*@
                        </div>
                    </form>
                </div>
            </div>
        </section>
    }
    else
    {
        <section class="hero is-link is-halfheight">
            <div class="hero-body container">
                <div class="has-text-centered">
                    <p class="title is-1">Real Property</p>
                    <p class="subtitle">A service of King County</p>
                    <form asp-page="./RealPropertyTaxYears" method="get" id="searchForm">
                        <div class="field is-grouped">
                            <p class="control is-expanded">
                                <input id="searchInput" class="input is-large" name="accountNumber" type="text" placeholder="Enter an account number" value="@Model?.ParcelNumber" onchange="handleSearchQuery(this)" autocomplete="off" oninput="onInput(this)">
                            </p>
                            @*<p class="control">
                                    <input type="submit" id="submitSearch" value="Search" class="button is-large is-link is-inverted is-focused" />
                                </p>*@
                        </div>
                    </form>
                </div>
            </div>
        </section>
    }
}

@{
    if (Model.TaxYears is not null && Model.TaxYears.Any())
    {
        <section class="section container pt-3">
            <nav class="breadcrumb is-centered has-arrow-separator mb-3" aria-label="breadcrumbs">
                <ul>
                    <li><a href="#">King County</a></li>
                    <li><a href="/RealProperty">Real Property</a></li>
                    <li><a href="/RealPropertyTaxYears">Tax Years</a></li>
                    <li class="is-active"><a href="#" aria-current="page">@Model?.TaxYears.Count() Results Found</a></li>
                </ul>
            </nav>
            @{
                if (Model?.TaxYears is not null)
                {
                    <div class="table-container">
                        <table class="table is-bordered is-striped is-narrow is-hoverable is-fullwidth is-inverted">
                            <thead>
                                <tr>
                                    <th>
                                        Year Valued
                                    </th>
                                    <th>
                                        Update Reason
                                    </th>
                                    <th>
                                        Tax Year
                                    </th>
                                    <th>
                                        Appraised Land Value
                                    </th>
                                    <th>
                                        Appraised Improvements Value
                                    </th>
                                    <th>
                                        Total Appraised Value
                                    </th>
                                    <th>
                                        Appraised Improvements Increase
                                    </th>
                                    <th>
                                        Taxable Land Value
                                    </th>
                                    <th>
                                        Taxable Improvements Value
                                    </th>
                                    <th class="is-selected">
                                        Total Taxable Value
                                    </th>
                                    <th>
                                        Levy Code
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                @{
                                    foreach (var year in Model?.TaxYears)
                                    {
                                        var yearAssessed = year.TaxYr + 1;
                                        var totalAppraised = year?.ApprImpsVal + year?.ApprLandVal;
                                        var totalTaxable = year?.LandVal + year?.ImpsVal;
                                        if (year.TaxYr == DateTime.Now.Year)
                                        {
                                            <tr class="is-selected">
                                                <td>
                                                    @yearAssessed
                                                </td>
                                                <td>
                                                    @year.Reason
                                                </td>
                                                <td>
                                                    @year.TaxYr
                                                </td>
                                                <td>
                                                    @year.ApprLandVal.ToString("C2")
                                                </td>
                                                <td>
                                                    @year.ApprImpsVal.ToString("C2")
                                                </td>
                                                <td>
                                                    @totalAppraised?.ToString("C2")
                                                </td>
                                                <td>
                                                    @year.ApprImpIncr.ToString("C2")
                                                </td>
                                                <td>
                                                    @year.LandVal.ToString("C2")
                                                </td>
                                                <td>
                                                    @year.ImpsVal.ToString("C2")
                                                </td>
                                                <td>
                                                    @totalTaxable?.ToString("C2")
                                                </td>
                                                <td>
                                                    @year.LevyCode
                                                </td>
                                            </tr>

                                        }
                                        else
                                        {
                                            <tr>
                                                <td>
                                                    @yearAssessed
                                                </td>
                                                <td>
                                                    @year.Reason
                                                </td>
                                                <td>
                                                    @year.TaxYr
                                                </td>
                                                <td>
                                                    @year.ApprLandVal.ToString("C2")
                                                </td>
                                                <td>
                                                    @year.ApprImpsVal.ToString("C2")
                                                </td>
                                                <td>
                                                    @totalAppraised?.ToString("C2")
                                                </td>
                                                <td>
                                                    @year.ApprImpIncr.ToString("C2")
                                                </td>
                                                <td>
                                                    @year.LandVal.ToString("C2")
                                                </td>
                                                <td>
                                                    @year.ImpsVal.ToString("C2")
                                                </td>
                                                <td class="is-selected">
                                                    @totalTaxable?.ToString("C2")
                                                </td>
                                                <td>
                                                    @year.LevyCode
                                                </td>
                                            </tr>

                                        }
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                }
            }
        </section>
    }
}